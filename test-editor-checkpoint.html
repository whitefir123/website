<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¼–è¾‘å™¨åŠŸèƒ½æ£€æŸ¥ç‚¹æµ‹è¯•</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: #050505;
            color: white;
            padding: 2rem;
        }
        .test-section {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .test-result {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            margin-top: 0.5rem;
        }
        .test-pass {
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid #10b981;
        }
        .test-fail {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid #ef4444;
        }
    </style>
</head>
<body>
    <h1 style="font-size: 2rem; font-weight: bold; margin-bottom: 2rem;">ç¼–è¾‘å™¨å¢å¼ºåŠŸèƒ½æ£€æŸ¥ç‚¹æµ‹è¯•</h1>
    
    <div id="test-results"></div>

    <!-- åŠ è½½æ‰€æœ‰æœåŠ¡ -->
    <script src="/js/services/markdown-parser.js"></script>
    <script src="/js/services/draft-service.js"></script>
    <script type="module">
        import exportService from '/js/services/export-service.js';
        window.exportService = exportService;
        
        // ç­‰å¾…æ‰€æœ‰è„šæœ¬åŠ è½½å®Œæˆåè¿è¡Œæµ‹è¯•
        setTimeout(() => {
            runTests();
        }, 500);
    </script>

    <script>
        function runTests() {
            const results = document.getElementById('test-results');
            const tests = [];

            // æµ‹è¯• 1: MarkdownParser ç±»å­˜åœ¨
            tests.push({
                name: 'ä»»åŠ¡ 1 - MarkdownParser ç±»å·²åˆ›å»º',
                pass: typeof MarkdownParser !== 'undefined',
                details: typeof MarkdownParser !== 'undefined' ? 'MarkdownParser ç±»å¯ç”¨' : 'MarkdownParser ç±»æœªæ‰¾åˆ°'
            });

            // æµ‹è¯• 2: DraftService ç±»å­˜åœ¨
            tests.push({
                name: 'ä»»åŠ¡ 1 - DraftService ç±»å·²åˆ›å»º',
                pass: typeof DraftService !== 'undefined',
                details: typeof DraftService !== 'undefined' ? 'DraftService ç±»å¯ç”¨' : 'DraftService ç±»æœªæ‰¾åˆ°'
            });

            // æµ‹è¯• 3: ExportService å­˜åœ¨
            tests.push({
                name: 'ä»»åŠ¡ 1 - ExportService å·²åˆ›å»º',
                pass: typeof window.exportService !== 'undefined',
                details: typeof window.exportService !== 'undefined' ? 'ExportService å®ä¾‹å¯ç”¨' : 'ExportService å®ä¾‹æœªæ‰¾åˆ°'
            });

            // æµ‹è¯• 4: MarkdownParser è§£ææ ‡é¢˜
            if (typeof MarkdownParser !== 'undefined') {
                const parser = new MarkdownParser();
                const result = parser.parse('# æµ‹è¯•æ ‡é¢˜\n\nè¿™æ˜¯ä¸€æ®µæ–‡å­—');
                const hasH1 = result.includes('<h1');
                tests.push({
                    name: 'ä»»åŠ¡ 2.1 - Markdown æ ‡é¢˜è§£æ',
                    pass: hasH1,
                    details: hasH1 ? 'æ ‡é¢˜è§£ææ­£å¸¸' : 'æ ‡é¢˜è§£æå¤±è´¥'
                });

                // æµ‹è¯• 5: MarkdownParser è§£æåŠ ç²—
                const boldResult = parser.parse('è¿™æ˜¯**åŠ ç²—æ–‡å­—**æµ‹è¯•');
                const hasBold = boldResult.includes('<strong');
                tests.push({
                    name: 'ä»»åŠ¡ 2.1 - Markdown åŠ ç²—è§£æ',
                    pass: hasBold,
                    details: hasBold ? 'åŠ ç²—è§£ææ­£å¸¸' : 'åŠ ç²—è§£æå¤±è´¥'
                });

                // æµ‹è¯• 6: MarkdownParser è§£æåˆ—è¡¨
                const listResult = parser.parse('- é¡¹ç›®1\n- é¡¹ç›®2');
                const hasList = listResult.includes('<ul') && listResult.includes('<li');
                tests.push({
                    name: 'ä»»åŠ¡ 2.1 - Markdown åˆ—è¡¨è§£æ',
                    pass: hasList,
                    details: hasList ? 'åˆ—è¡¨è§£ææ­£å¸¸' : 'åˆ—è¡¨è§£æå¤±è´¥'
                });
            }

            // æµ‹è¯• 7: DraftService ä¿å­˜å’ŒåŠ è½½
            if (typeof DraftService !== 'undefined') {
                const draftService = new DraftService();
                const testDraft = {
                    title: 'æµ‹è¯•æ ‡é¢˜',
                    content: 'æµ‹è¯•å†…å®¹',
                    moodId: 'happy',
                    timestamp: Date.now()
                };
                
                const saved = draftService.saveDraft(testDraft);
                const loaded = draftService.loadDraft();
                const matches = loaded && loaded.title === testDraft.title && loaded.content === testDraft.content;
                
                tests.push({
                    name: 'ä»»åŠ¡ 3.1 - è‰ç¨¿ä¿å­˜å’ŒåŠ è½½',
                    pass: saved && matches,
                    details: saved && matches ? 'è‰ç¨¿ä¿å­˜å’ŒåŠ è½½æ­£å¸¸' : 'è‰ç¨¿ä¿å­˜æˆ–åŠ è½½å¤±è´¥'
                });

                // æ¸…ç†æµ‹è¯•æ•°æ®
                draftService.clearDraft();
            }

            // æµ‹è¯• 8: ExportService æ–‡ä»¶åç”Ÿæˆ
            if (typeof window.exportService !== 'undefined') {
                const filename = window.exportService.generateFilename();
                const isValid = /^journal-\d{4}-\d{2}-\d{2}-\d{6}\.json$/.test(filename);
                tests.push({
                    name: 'ä»»åŠ¡ 4.2 - JSON æ–‡ä»¶åæ ¼å¼',
                    pass: isValid,
                    details: isValid ? `æ–‡ä»¶åæ ¼å¼æ­£ç¡®: ${filename}` : `æ–‡ä»¶åæ ¼å¼é”™è¯¯: ${filename}`
                });

                // æµ‹è¯• 9: ExportService å¾€è¿”ä¸€è‡´æ€§
                const testEntry = {
                    id: 'test-123',
                    title: 'æµ‹è¯•æ—¥å¿—',
                    content: 'æµ‹è¯•å†…å®¹',
                    timestamp: Date.now()
                };
                const roundTrip = window.exportService.validateRoundTrip(testEntry);
                tests.push({
                    name: 'ä»»åŠ¡ 4.2 - JSON å¾€è¿”ä¸€è‡´æ€§',
                    pass: roundTrip,
                    details: roundTrip ? 'JSON åºåˆ—åŒ–å’Œååºåˆ—åŒ–ä¸€è‡´' : 'JSON å¾€è¿”ä¸ä¸€è‡´'
                });
            }

            // æµ‹è¯• 10: æ£€æŸ¥ journal-editor.html æ˜¯å¦åŒ…å«ä¿å­˜åˆ°æœ¬åœ°æŒ‰é’®
            fetch('/journal-editor.html')
                .then(response => response.text())
                .then(html => {
                    const hasLocalSaveBtn = html.includes('id="save-local"');
                    tests.push({
                        name: 'ä»»åŠ¡ 4.1 - ä¿å­˜åˆ°æœ¬åœ°æŒ‰é’®å·²æ·»åŠ ',
                        pass: hasLocalSaveBtn,
                        details: hasLocalSaveBtn ? 'ä¿å­˜åˆ°æœ¬åœ°æŒ‰é’®å­˜åœ¨äº HTML ä¸­' : 'ä¿å­˜åˆ°æœ¬åœ°æŒ‰é’®æœªæ‰¾åˆ°'
                    });

                    // æµ‹è¯• 11: æ£€æŸ¥å¿ƒæƒ…ä¸‹æ‹‰èœå•æ ·å¼
                    const hasMoodStyles = html.includes('#journal-mood option');
                    tests.push({
                        name: 'ä»»åŠ¡ 5.1 - å¿ƒæƒ…ä¸‹æ‹‰èœå•æ ·å¼å·²ä¼˜åŒ–',
                        pass: hasMoodStyles,
                        details: hasMoodStyles ? 'å¿ƒæƒ…ä¸‹æ‹‰èœå•æ ·å¼å·²å®šä¹‰' : 'å¿ƒæƒ…ä¸‹æ‹‰èœå•æ ·å¼æœªæ‰¾åˆ°'
                    });

                    renderResults(tests);
                })
                .catch(error => {
                    console.error('åŠ è½½ journal-editor.html å¤±è´¥:', error);
                    renderResults(tests);
                });
        }

        function renderResults(tests) {
            const results = document.getElementById('test-results');
            const passCount = tests.filter(t => t.pass).length;
            const totalCount = tests.length;
            
            let html = `
                <div class="test-section" style="background: rgba(139, 92, 246, 0.1); border-color: #8b5cf6;">
                    <h2 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem;">
                        æµ‹è¯•ç»“æœæ€»è§ˆ: ${passCount} / ${totalCount} é€šè¿‡
                    </h2>
                    <div style="width: 100%; background: rgba(255,255,255,0.1); height: 8px; border-radius: 4px; overflow: hidden;">
                        <div style="width: ${(passCount/totalCount)*100}%; background: #10b981; height: 100%; transition: width 0.3s;"></div>
                    </div>
                </div>
            `;

            tests.forEach((test, index) => {
                html += `
                    <div class="test-section">
                        <h3 style="font-weight: 600; margin-bottom: 0.5rem;">
                            ${index + 1}. ${test.name}
                        </h3>
                        <div class="test-result ${test.pass ? 'test-pass' : 'test-fail'}">
                            <strong>${test.pass ? 'âœ“ é€šè¿‡' : 'âœ— å¤±è´¥'}</strong>: ${test.details}
                        </div>
                    </div>
                `;
            });

            if (passCount === totalCount) {
                html += `
                    <div class="test-section" style="background: rgba(16, 185, 129, 0.2); border-color: #10b981;">
                        <h2 style="font-size: 1.5rem; font-weight: bold; color: #10b981;">
                            ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼ç¼–è¾‘å™¨å¢å¼ºåŠŸèƒ½æ­£å¸¸å·¥ä½œã€‚
                        </h2>
                        <p style="margin-top: 0.5rem; color: rgba(255,255,255,0.7);">
                            ä»»åŠ¡ 1-5 çš„æ‰€æœ‰åŠŸèƒ½å·²æˆåŠŸå®ç°å¹¶éªŒè¯ã€‚
                        </p>
                    </div>
                `;
            } else {
                html += `
                    <div class="test-section" style="background: rgba(239, 68, 68, 0.2); border-color: #ef4444;">
                        <h2 style="font-size: 1.5rem; font-weight: bold; color: #ef4444;">
                            âš ï¸ éƒ¨åˆ†æµ‹è¯•å¤±è´¥
                        </h2>
                        <p style="margin-top: 0.5rem; color: rgba(255,255,255,0.7);">
                            è¯·æ£€æŸ¥å¤±è´¥çš„æµ‹è¯•é¡¹å¹¶ä¿®å¤é—®é¢˜ã€‚
                        </p>
                    </div>
                `;
            }

            results.innerHTML = html;
        }
    </script>
</body>
</html>
