# 实施计划：日志编辑器增强

## 概述

本实施计划将日志编辑器增强功能分解为离散的编码步骤，每个任务都建立在前一个任务的基础上。实施将按照三个模块进行：编辑器体验增强、心情记录交互增强和统计功能增强。所有代码使用 JavaScript 实现，遵循现有项目的代码风格和架构模式。

## 任务

- [x] 1. 创建核心服务类和工具函数
  - 创建 `js/services/markdown-parser.js` 实现 Markdown 解析器
  - 创建 `js/services/draft-service.js` 实现草稿管理
  - 创建 `js/services/export-service.js` 实现 JSON 导出
  - 创建 `js/utils/animation-controller.js` 实现动画控制器
  - 创建 `js/utils/mood-filter-controller.js` 实现心情过滤控制器
  - _需求：1.1, 2.1, 3.2, 5.2, 11.1_

- [x] 2. 增强日志编辑器 - Markdown 实时预览
  - [x] 2.1 在 `journal-editor.js` 中集成 MarkdownParser
    - 导入 MarkdownParser 类
    - 在 `renderPreview` 方法中调用解析器
    - 为预览区域添加 Tailwind 样式类以保持视觉一致性
    - _需求：1.1, 1.2, 1.3, 1.4, 1.5_

- [x] 3. 增强日志编辑器 - 本地草稿自动保存
  - [x] 3.1 在 `journal-editor.js` 中集成 DraftService
    - 导入 DraftService 类
    - 在标题和内容输入事件中调用 `saveDraft`
    - 在页面加载时调用 `loadDraft` 并显示恢复对话框
    - 在成功提交后调用 `clearDraft`
    - _需求：2.1, 2.2, 2.3, 2.4, 2.5_

- [x] 4. 增强日志编辑器 - 一键下载 JSON
  - [x] 4.1 在 `journal-editor.html` 中添加"保存到本地"按钮
    - 在提交按钮旁添加新按钮
    - 应用大厂风格样式（渐变背景、阴影、hover 效果）
    - _需求：3.1_
  
  - [x] 4.2 在 `journal-editor.js` 中集成 ExportService
    - 导入 ExportService 类
    - 为"保存到本地"按钮绑定点击事件
    - 调用 `exportToJSON` 并显示成功提示
    - _需求：3.2, 3.3, 3.4, 3.5_

- [x] 5. 增强日志编辑器 - 心情关联视觉同步
  - [x] 5.1 优化"关联今日心情"下拉菜单样式
    - 为每个选项应用对应心情的 10% 透明度背景色
    - 确保文字对比度符合 WCAG 标准
    - 添加 hover 状态（20% 透明度 + 过渡效果）
    - _需求：4.1, 4.2, 4.3, 4.4_

- [x] 6. 检查点 - 确保编辑器增强功能正常工作
  - 确保所有测试通过，如有问题请询问用户。

- [x] 7. 增强心情记录 - 保存动效反馈
  - [x] 7.1 在 `mood-record-modal.js` 中触发保存动效
    - 在保存成功后调用 MoodCalendar 的动画方法
    - 传递日期参数以定位目标单元格
    - _需求：5.1, 5.5_
  
  - [x] 7.2 在 `mood-calendar.js` 中实现 spring-bounce 动画
    - 使用 AnimationController 执行动画
    - 应用 cubic-bezier(0.34, 1.56, 0.64, 1) 曲线
    - 动画完成后显示成功勾选标记
    - _需求：5.2, 5.3, 5.4_

- [x] 8. 增强心情记录 - 动态备注占位符
  - [x] 8.1 在 `mood-record-modal.js` 中实现占位符配置
    - 创建心情类型到占位符文本的映射对象
    - 在心情选择事件中更新 textarea 占位符
    - 添加淡入过渡效果
    - _需求：6.1, 6.2, 6.4_

- [x] 9. 增强心情记录 - 快捷记录功能
  - [x] 9.1 在 `mood-calendar.js` 中实现双击快捷记录
    - 为日期单元格绑定 dblclick 事件
    - 检查是否已有记录，如有则打开编辑弹窗
    - 如无记录则自动创建 neutral 类型记录
    - 确保双击不触发单击事件（使用防抖或事件标志）
    - 执行相同的保存动效
    - _需求：7.1, 7.2, 7.3, 7.4_

- [x] 10. 增强心情记录 - Modal 视觉优化
  - [x] 10.1 优化 `mood-record-modal.js` 和对应 HTML 的样式
    - 为遮罩层添加 backdrop-blur-sm 类
    - 设置遮罩层背景色为 hsl(240 10% 3.9% / 0.8)
    - 确保所有交互元素具有 duration-300 ease-in-out 过渡
    - _需求：8.1, 8.2, 8.4_

- [x] 11. 检查点 - 确保心情记录增强功能正常工作
  - 确保所有测试通过，如有问题请询问用户。

- [x] 12. 增强统计功能 - 生活建议生成
  - [x] 12.1 在 `emotion-statistics.js` 中实现主导心情识别
    - 分析月度心情数据，计算各类型频率
    - 识别出现频率最高的心情类型
    - _需求：9.1, 9.2_
  
  - [x] 12.2 创建生活建议配置并渲染
    - 创建心情类型到建议文本的映射对象
    - 在统计图表下方添加建议区域
    - 根据主导心情显示对应建议
    - _需求：9.3, 9.4_

- [x] 13. 增强统计功能 - 统计条动效升级
  - [x] 13.1 在 `emotion-statistics.js` 中实现统计条入场动画
    - 使用 Intersection Observer 检测统计条进入视口
    - 使用 AnimationController 执行伸展动画
    - 应用 cubic-bezier(0.34, 1.56, 0.64, 1) 曲线
    - 为每个统计条设置递增的动画延迟（如 100ms, 200ms, 300ms）
    - _需求：10.1, 10.2, 10.3, 10.4_

- [x] 14. 增强统计功能 - 交互式心情过滤
  - [x] 14.1 在 `emotion-statistics.js` 中实现过滤触发
    - 为统计面板中的心情类型绑定点击事件
    - 调用 MoodFilterController 激活过滤
    - 传递选中的心情类型参数
    - _需求：11.1, 11.2_
  
  - [x] 14.2 在 `mood-calendar.js` 中实现过滤高亮
    - 实现 `highlightDates` 方法
    - 高亮匹配日期，降低非匹配日期透明度至 30%
    - 实现 `clearFilter` 方法恢复所有日期显示
    - 添加"清除过滤"按钮或支持再次点击相同心情清除
    - _需求：11.3, 11.4, 11.5_

- [x] 15. 错误处理和边缘情况
  - [x] 15.1 实现 Markdown 解析容错
    - 处理不完整语法，按原文显示
    - 添加开发模式警告日志
    - _需求：1.1_
  
  - [x] 15.2 实现 LocalStorage 配额超限处理
    - 捕获 QuotaExceededError 异常
    - 显示友好提示并尝试清理旧草稿
    - _需求：2.1_
  
  - [x] 15.3 实现 JSON 导出降级方案
    - 检测 Blob API 支持性
    - 提供备选方案（新窗口显示 JSON 文本）
    - _需求：3.2_
  
  - [x] 15.4 实现动画性能优化
    - 检测 prefers-reduced-motion 偏好
    - 使用 will-change 优化动画性能
    - _需求：5.2, 10.1_
  
  - [x] 15.5 实现过滤防抖和状态管理
    - 添加 300ms 防抖避免快速切换冲突
    - 维护单一过滤状态源
    - _需求：11.1_
  
  - [x] 15.6 实现草稿时间戳过期检查
    - 检查草稿是否超过 7 天
    - 提供查看或丢弃选项
    - _需求：2.2_

- [x] 16. 集成和最终调整
  - [x] 16.1 确保所有模块正确集成
    - 验证模块间通信正常
    - 检查事件监听器正确绑定
    - 确保样式一致性
    - _需求：所有_
  
  - [x] 16.2 性能优化和浏览器兼容性测试
    - 测试 Markdown 解析性能（大文本）
    - 测试动画帧率
    - 验证目标浏览器兼容性
    - _需求：所有_

- [x] 17. 最终检查点 - 确保所有功能正常工作
  - 确保所有测试通过，所有功能符合设计要求，如有问题请询问用户。

## 注意事项

- 每个任务都引用了具体的需求以确保可追溯性
- 检查点确保增量验证
- 属性测试验证通用正确性属性
- 单元测试验证特定示例和边缘情况
- 所有代码应遵循现有项目的代码风格和 Tailwind CSS 使用规范
- 确保所有交互具有 duration-300 ease-in-out 过渡效果
- 遵循 60-30-10 视觉设计原则
